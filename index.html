<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tren NeuroLex Explorer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
  />
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
  <nav class="bg-indigo-600 text-white p-4 shadow">
    <h1 class="text-xl font-semibold flex items-center gap-2">
      <i class="bi bi-brain"></i> Tren NeuroLex Explorer
    </h1>
  </nav>

  <main class="max-w-5xl mx-auto p-6">
    <section class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-1">Search logical query:</label>
      <div class="flex gap-2">
        <input id="queryInput" class="flex-1 border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-indigo-400" placeholder="Example: amygdala not emotion" />
        <button id="queryBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg"><i class="bi bi-search"></i> Search</button>
      </div>
    </section>

    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-2">All Terms</h2>
      <div id="terms" class="border border-gray-200 rounded-lg p-4 bg-white max-h-80 overflow-y-scroll text-sm grid grid-cols-2 md:grid-cols-4 gap-1">
        <p class="col-span-full text-gray-500">Loading terms...</p>
      </div>
    </section>

    <section id="relatedSection" class="hidden mb-6">
      <h2 class="text-lg font-semibold mb-2">Related Terms for <span id="currentTerm" class="font-bold"></span></h2>
      <div id="related" class="border border-gray-200 rounded-lg p-4 bg-white text-sm grid grid-cols-2 md:grid-cols-3 gap-1"></div>
    </section>

    <section id="studiesSection" class="hidden">
      <h2 class="text-lg font-semibold mb-2">Study Results</h2>
      <div id="studies" class="border border-gray-200 rounded-lg p-4 bg-white text-sm space-y-2"></div>
    </section>
  </main>

  <script>
    const BASE = "https://mil.psy.ntu.edu.tw:5000";

    async function fetchJSON(url) {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return await resp.json();
    }

    async function loadTerms() {
      const termsDiv = document.getElementById("terms");
      try {
        const data = await fetchJSON(`${BASE}/terms`);
        termsDiv.innerHTML = "";
        data.terms.slice(0, 2000).forEach(t => {
          const btn = document.createElement("button");
          btn.className = "text-indigo-700 hover:bg-indigo-100 rounded px-2 py-1 text-left";
          btn.textContent = t;
          btn.onclick = () => showRelated(t);
          termsDiv.appendChild(btn);
        });
      } catch (err) {
        termsDiv.innerHTML = `<p class='text-red-500'>Error loading terms: ${err.message}</p>`;
      }
    }

    async function showRelated(term) {
      const sec = document.getElementById("relatedSection");
      const relDiv = document.getElementById("related");
      document.getElementById("currentTerm").textContent = term;
      sec.classList.remove("hidden");
      relDiv.innerHTML = "<p class='col-span-full text-gray-500'>Loading…</p>";

      try {
        const data = await fetchJSON(`${BASE}/terms/${encodeURIComponent(term)}`);
        relDiv.innerHTML = "";
        data.related.slice(0, 50).forEach(r => {
          const tag = document.createElement("span");
          tag.className = "bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 rounded px-2 py-1 cursor-pointer";
          tag.textContent = `${r.term} (${r.jaccard.toFixed(2)})`;
          tag.onclick = () => showRelated(r.term);
          relDiv.appendChild(tag);
        });
      } catch (err) {
        relDiv.innerHTML = `<p class='text-red-500'>Error: ${err.message}</p>`;
      }
    }

    async function searchStudies() {
      const q = document.getElementById("queryInput").value.trim();
      if (!q) return;
      const sec = document.getElementById("studiesSection");
      const list = document.getElementById("studies");
      sec.classList.remove("hidden");
      list.innerHTML = "<p class='text-gray-500'>Searching…</p>";
      try {
        const data = await fetchJSON(`${BASE}/query/${encodeURIComponent(q)}/studies`);
        list.innerHTML = `<p class='text-gray-600 mb-2'>Found ${data.count} studies</p>`;
        data.results.slice(0, 50).forEach(st => {
          const div = document.createElement("div");
          div.className = "border-b pb-2";
          div.innerHTML = `
            <p class="font-semibold">${st.title}</p>
            <p class="text-gray-600">${st.authors} (${st.year})</p>
            <p class="text-gray-500 italic">${st.journal}</p>
          `;
          list.appendChild(div);
        });
      } catch (err) {
        list.innerHTML = `<p class='text-red-500'>Error: ${err.message}</p>`;
      }
    }

    document.getElementById("queryBtn").addEventListener("click", searchStudies);
    loadTerms();
  </script>
</body>
</html>
